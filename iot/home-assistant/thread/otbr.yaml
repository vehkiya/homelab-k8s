apiVersion: v1
kind: Service
metadata:
  name: otbr-ui
  namespace: home-assistant
spec:
  selector:
    app: otbr # select pods that match this label
  ports:
    - port: 8080
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: otbr
  namespace: home-assistant
spec:
  serviceName: otbr
  replicas: 1 # You can adjust the number of replicas here
  selector:
    matchLabels:
      app: otbr
  template:
    metadata:
      labels:
        app: otbr # label pods with this label
    spec:
      nodeName: "lab-1"
      hostNetwork: true
      containers:
        - image: ghcr.io/ownbee/hass-otbr-docker:latest
          imagePullPolicy: Always
          name: otbr
          ports:
            - containerPort: 8080 # Web UI port (adjust if needed)
            - containerPort: 8443
          securityContext:
            privileged: true
            capabilities:
              add:
                # Use 'add' to specify capabilities to add
                - NET_ADMIN
                - SYS_ADMIN
          env:
#            # Configuration environment variables for OTBR
            - name: OTBR_REST_PORT
              value: "8443"
            - name: OTBR_WEB_PORT
              value: "8080"
            - name: NETWORK_DEVICE
              value: "192.168.4.36:6638"
#            - name: BACKBONE_IF
#              value: "enp3s0"
            - name: FLOW_CONTROL
              value: "0"
            - name: AUTOFLASH_FIRMWARE
              value: "0"
            - name: NAT64
              value: "0"
            - name: FIREWALL
              value: "0"
#            - name: OTBR_CHANNEL # The channel for your Thread network
#              value: "15"
#            - name: OTBR_MASTER_KEY # The master key for your Thread network (hex)
#              valueFrom: # Use a Kubernetes Secret for sensitive data
#                secretKeyRef:
#                  name: otbr-secrets # Name of your Kubernetes Secret
#                  key: master_key # Key in the Secret containing the master key
#            - name: OTBR_BORDER_ROUTER_CONFIG # Additional configuration (optional)
#              value: "-v DEBUG"  # Example: Enable debug logging
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: otbr-ui-route
  namespace: home-assistant # Where your application is deployed
spec:
  parentRefs:
    - name: traefik-gateway
      namespace: traefik
  hostnames:
    - "otb.kerrlab.app"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        # Use backendRefs for Gateway API v1beta1
        - name: otbr-ui
          port: 8080
