name: CI

on:
  pull_request:
  push:
    branches: [main, master]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get Renovate version
        id: renovate-version
        run: echo "VERSION=$(npm view renovate version)" >> $GITHUB_OUTPUT

      - name: Cache Renovate
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-renovate-${{ steps.renovate-version.outputs.VERSION }}

      - name: Validate Renovate Config
        run: npx --prefer-offline --yes --package renovate@${{ steps.renovate-version.outputs.VERSION }} renovate-config-validator

      - name: Lint YAML
        uses: ibiqlik/action-yamllint@v3
        with:
          config_data: |
            extends: default
            rules:
              line-length: disable
              trailing-spaces: disable
              document-start: disable
              truthy: disable
              new-line-at-end-of-file: disable
              comments: disable
              comments-indentation: disable
              braces: disable
              brackets: disable
              empty-lines: disable

      - name: Setup Cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/kubeconform
            ~/.cache/kustomize
          key: ${{ runner.os }}-k8s-cache-${{ hashFiles('**/kustomization.yaml') }}
          restore-keys: |
            ${{ runner.os }}-k8s-cache-

      - name: Install Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Install Kube-linter
        run: |
          wget https://github.com/stackrox/kube-linter/releases/download/v0.7.1/kube-linter-linux.tar.gz
          tar xf kube-linter-linux.tar.gz
          sudo mv kube-linter /usr/local/bin/
          rm kube-linter-linux.tar.gz

      - name: Build & Validate Kustomize Layers
        run: |
          mkdir -p ~/.cache/kubeconform
          set -o pipefail

          # Determine changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          # Find unique directories with kustomization.yaml closest to changed files
          LAYERS=$(echo "$CHANGED_FILES" | while read file; do
            dir=$(dirname "$file")
            while [ "$dir" != "." ] && [ "$dir" != "/" ]; do
              if [ -f "$dir/kustomization.yaml" ]; then
                echo "$dir"
                break
              fi
              dir=$(dirname "$dir")
            done
          done | sort -u)

          if [ -z "$LAYERS" ]; then
            echo "No Kustomize layers affected by changes."
            exit 0
          fi

          echo "Validating the following layers:"
          echo "$LAYERS"

          for layer in $LAYERS; do
            echo "Validating $layer..."
            # Build once and store in a temporary file
            kustomize build "$layer" --enable-helm > built.yaml

            echo "--- Kubeconform ---"
            kubeconform -summary -ignore-missing-schemas -strict -skip "Secret,SealedSecret" \
            -cache ~/.cache/kubeconform built.yaml || \
            { echo "Kubeconform failed for $layer"; exit 1; }

            echo "--- Kube-linter ---"
            kube-linter lint built.yaml || \
            { echo "Kube-linter failed for $layer"; exit 1; }
          done
