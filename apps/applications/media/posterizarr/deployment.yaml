apiVersion: apps/v1
kind: Deployment
metadata:
  name: posterizarr
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: posterizarr
  template:
    metadata:
      labels:
        app: posterizarr
    spec:
      dnsPolicy: None
      securityContext:
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
        supplementalGroups:
          - 6
      dnsConfig:
        searches:
          - iot.svc.cluster.local
          - svc.cluster.local
          - cluster.local
        nameservers:
          - 10.96.0.10
        options:
          - name: ndots
            value: "5"
      terminationGracePeriodSeconds: 30
      initContainers:
        - name: prepare-config
          image: alpine/k8s:1.34.1
          command:
            - /bin/sh
            - -c
            - |
              echo "üöÄ Starting Configuration Processing..."
              echo "--------------------------------------------------"
              DEBUG="false"

              CONFIG_TEMPLATE_PATH="/config_templates/config.json.template"
              FINAL_CONFIG_PATH="/config/config.json"
              SECRETS_DIR="/etc/posterizarr-secrets"

              echo "üîê Loading secrets from $SECRETS_DIR..."
              export DISCORD_WEBHOOK=$(cat $SECRETS_DIR/DISCORD_WEBHOOK)
              export FANART_PERSONAL_API_KEY=$(cat $SECRETS_DIR/FANART_PERSONAL_API_KEY)
              export PLEX_TOKEN=$(cat $SECRETS_DIR/PLEX_TOKEN)
              export TMDB_API_TOKEN=$(cat $SECRETS_DIR/TMDB_API_TOKEN)
              export TVDB_API_KEY=$(cat $SECRETS_DIR/TVDB_API_KEY)
              echo "‚úÖ Secrets loaded into script environment."
              echo "--------------------------------------------------"

              echo "‚ÑπÔ∏è Template Path: $CONFIG_TEMPLATE_PATH"
              echo "‚ÑπÔ∏è Output Path: $FINAL_CONFIG_PATH"
              echo "--------------------------------------------------"

              # Check if template file exists
              if [ ! -f "$CONFIG_TEMPLATE_PATH" ]; then
                echo "‚ùå ERROR: Config template '$CONFIG_TEMPLATE_PATH' not found! Aborting."
                exit 1
              fi

              if [ "$DEBUG" = "true" ]; then
                echo "üìÑ Contents of template '$CONFIG_TEMPLATE_PATH':"
                cat "$CONFIG_TEMPLATE_PATH"
                echo "--------------------------------------------------"
              fi

              echo "‚öôÔ∏è  Generating final configuration file from template..."
              if envsubst < "$CONFIG_TEMPLATE_PATH" > "$FINAL_CONFIG_PATH"; then
                echo "‚úÖ Configuration file '$FINAL_CONFIG_PATH' generated successfully."
              else
                echo "‚ùå ERROR: Failed to generate configuration file '$FINAL_CONFIG_PATH' using envsubst."
                ls -la /config
                exit 1 # Critical step failed
              fi
              echo "--------------------------------------------------"

              if [ "$DEBUG" = "true" ]; then
                echo "üìÑ Verifying generated configuration file '$FINAL_CONFIG_PATH':"
                cat "$FINAL_CONFIG_PATH" # For verification in logs
                echo "--------------------------------------------------"

                echo "üîé Contents of /config directory after processing:"
                ls -la /config
                echo "--------------------------------------------------"
              fi
              
              echo "üìÑ Processing custom fonts..."
              # Space-separated list of font filenames to copy
              FONT_LIST="Montserrat-Medium.ttf"
              FONT_SOURCE_DIR="/tmp/fonts"
              FONT_DEST_DIR="/config"

              for FONT_FILENAME in $FONT_LIST; do
                # This uses find to locate the font file within the source directory structure
                FONT_SOURCE_PATH=$(find "$FONT_SOURCE_DIR" -type f -name "$FONT_FILENAME" | head -n 1)
                FONT_DEST_PATH="$FONT_DEST_DIR/$FONT_FILENAME"
                if [ -n "$FONT_SOURCE_PATH" ] && [ ! -f "$FONT_DEST_PATH" ]; then
                  echo "‚ÑπÔ∏è Font '$FONT_FILENAME' not found in destination. Copying..."
                  cp "$FONT_SOURCE_PATH" "$FONT_DEST_PATH"
                elif [ -f "$FONT_DEST_PATH" ]; then
                  echo "Font '$FONT_FILENAME' already exists. Skipping."
                else
                  echo "‚ö†Ô∏è WARNING: Font '$FONT_FILENAME' not found in source directory '$FONT_SOURCE_DIR'."
                fi
              done
              echo "‚úÖ Font processing complete"

              echo "üéâ Configuration processing complete."
          volumeMounts:
            - name: config
              mountPath: /config
            - name: app-config-tpl-volume # Mount the ConfigMap template
              mountPath: /config_templates
            - name: posterizarr-secret-volume
              mountPath: /etc/posterizarr-secrets
              readOnly: true
            - name: fonts
              mountPath: /tmp/fonts
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
      containers:
        - name: posterizarr
          image: ghcr.io/fscorrupt/posterizarr:2.0.6
          env:
            - name: TZ
              value: "Europe/Chisinau"
            - name: RUN_TIME
              value: "06:00"
          volumeMounts:
            - name: assets
              mountPath: /assets
            - name: config
              mountPath: /config
          securityContext:
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: posterizarr-config-pvc
        - name: assets
          persistentVolumeClaim:
            claimName: video-assets-pvc
        - name: fonts
          persistentVolumeClaim:
            claimName: fonts-pvc
        - name: app-config-tpl-volume
          configMap:
            name: posterizarr-configmap
            items:
              - key: config.json.template
                path: config.json.template
        - name: posterizarr-secret-volume
          secret:
            secretName: posterizarr-secret