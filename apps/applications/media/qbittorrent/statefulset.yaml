apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: qbittorrent
  namespace: media
spec:
  serviceName: qbittorrent
  replicas: 1
  selector:
    matchLabels:
      app: qbittorrent
  template:
    metadata:
      labels:
        app: qbittorrent
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1 # A higher weight means a stronger preference
              preference:
                matchExpressions:
                  - key: networkSpeed
                    operator: In
                    values:
                      - "2.5G"
      initContainers:
        - name: install-vuetorrent
          image: alpine/k8s
          command:
            - /bin/sh
            - -c
            - |
              VERSION="v2.28.2"
              DOWNLOAD_URL="https://github.com/VueTorrent/VueTorrent/releases/download/${VERSION}/vuetorrent.zip"

              echo "Downloading VueTorrent version ${VERSION}..."
              curl -L "$DOWNLOAD_URL" -o /tmp/vuetorrent.zip

              if [ ! -f /tmp/vuetorrent.zip ]; then
                echo "Download failed. Exiting."
                exit 1
              fi

              echo "Unpacking to /vuetorrent..."
              # Now the unzip command will work
              unzip /tmp/vuetorrent.zip -d /

              # Clean up
              rm /tmp/vuetorrent.zip

              echo "VueTorrent installation complete."
          volumeMounts:
            - name: vuetorrent-webui
              mountPath: /vuetorrent
          securityContext:
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
        - name: gluetun
          image: qmcgaw/gluetun
          restartPolicy: Always # Declares this as a native sidecar
          securityContext:
            runAsUser: 0
            runAsNonRoot: false
            capabilities:
              add:
                - NET_ADMIN
            allowPrivilegeEscalation: false
          env:
            - name: VPN_SERVICE_PROVIDER
              value: "protonvpn"
            - name: VPN_TYPE
              value: "wireguard"
            - name: SERVER_COUNTRIES
              value: "Switzerland"
            - name: PORT_FORWARDING
              value: "on"
            - name: PORT_FORWARD_ONLY
              value: "on"
            - name: FIREWALL_INPUT_PORTS
              value: "8080"
            - name: FIREWALL_OUTBOUND_SUBNETS
              value: "10.244.0.0/16,10.96.0.0/12,10.10.0.0/16"
            - name: DNS_ADDRESS
              value: "10.96.0.10"
            - name: DOT
              value: "off"
            - name: VPN_PORT_FORWARDING
              value: "on"
            - name: WIREGUARD_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: gluetun-secret
                  key: WIREGUARD_PRIVATE_KEY
          volumeMounts:
            - name: gluetun-port-data
              mountPath: /tmp/gluetun
      containers:
        - name: qbittorrent
          image: ghcr.io/home-operations/qbittorrent
          env:
            - name: TZ
              value: "Europe/Chisinau"
            - name: WEBUI_PATH
              value: "/vuetorrent"
          ports:
            - name: web-ui
              containerPort: 8080
          startupProbe:
            httpGet:
              path: /
              port: web-ui
            failureThreshold: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: web-ui
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /
              port: web-ui
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          volumeMounts:
            - name: downloads-mount
              mountPath: /downloads # Path inside the container
            - name: config
              mountPath: /config
            - name: vuetorrent-webui
              mountPath: /vuetorrent
            - name: gluetun-port-data
              mountPath: /tmp/gluetun
              readOnly: true
          securityContext:
            runAsGroup: 100
            runAsNonRoot: true
            runAsUser: 1026
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
        - name: qbit-port-sync
          image: ghcr.io/vehkiya/qbit-gluetun-sync
          env:
            - name: QBIT_ADDR
              value: "http://localhost:8080"
            - name: PORT_FILE
              value: "/tmp/gluetun/forwarded_port"
            - name: LISTEN_PORT
              value: "9090"
          volumeMounts:
            - name: gluetun-port-data
              mountPath: /tmp/gluetun
              readOnly: true
          resources:
            requests:
              cpu: "5m"
              memory: "16Mi"
            limits:
              cpu: "50m"
              memory: "64Mi"
          securityContext:
            runAsUser: 1026
            runAsGroup: 100
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
        - name: qbit-ntfy
          image: ghcr.io/vehkiya/qbit-ntfy-sidecar
          env:
            - name: QBIT_HOST
              value: "http://localhost:8080"
            - name: NTFY_SERVER
              value: "http://ntfy.monitoring.svc.cluster.local"
            - name: NTFY_TOPIC
              value: "downloads"
            - name: NTFY_PRIORITY_PROGRESS
              value: "low"
            - name: NTFY_PRIORITY_COMPLETE
              value: "default"
            - name: NOTIFY_COMPLETE
              value: "true"
            - name: PROGRESS_FORMAT
              value: "bar"
          envFrom:
            - secretRef:
                name: ntfy-credentials
          resources:
            requests:
              cpu: "10m"
              memory: "32Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"
      dnsConfig:
        options:
          - name: ndots
            value: "1"
      securityContext:
        fsGroup: 65534
        fsGroupChangePolicy: OnRootMismatch
      volumes:
        - name: downloads-mount
          persistentVolumeClaim:
            claimName: downloads-pvc
        - name: config
          persistentVolumeClaim:
            claimName: qbittorrent-config-pvc
        - name: vuetorrent-webui
          emptyDir: {}
        - name: gluetun-port-data
          emptyDir: {}
