apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: qbittorrent
  namespace: media
spec:
  serviceName: qbittorrent
  replicas: 1
  selector:
    matchLabels:
      app: qbittorrent
  template:
    metadata:
      labels:
        app: qbittorrent
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1 # A higher weight means a stronger preference
              preference:
                matchExpressions:
                  - key: networkSpeed
                    operator: In
                    values:
                      - "2.5G"
      initContainers:
        - name: install-vuetorrent
          image: alpine/k8s
          command:
            - /bin/sh
            - -c
            - |
              VERSION="v2.28.2"
              DOWNLOAD_URL="https://github.com/VueTorrent/VueTorrent/releases/download/${VERSION}/vuetorrent.zip"

              echo "Downloading VueTorrent version ${VERSION}..."
              curl -L "$DOWNLOAD_URL" -o /tmp/vuetorrent.zip

              if [ ! -f /tmp/vuetorrent.zip ]; then
                echo "Download failed. Exiting."
                exit 1
              fi

              echo "Unpacking to /vuetorrent..."
              # Now the unzip command will work
              unzip /tmp/vuetorrent.zip -d /

              # Clean up
              rm /tmp/vuetorrent.zip

              echo "VueTorrent installation complete."
          volumeMounts:
            - name: vuetorrent-webui
              mountPath: /vuetorrent
          securityContext:
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
      containers:
        - name: qbittorrent
          image: ghcr.io/home-operations/qbittorrent
          env:
            - name: TZ
              value: "Europe/Chisinau"
            - name: WEBUI_PATH
              value: "/vuetorrent"
          ports:
            - name: web-ui
              containerPort: 8080
            - containerPort: 56883
              name: torrent-port
          startupProbe:
            httpGet:
              path: /
              port: web-ui
            failureThreshold: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: web-ui
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /
              port: web-ui
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          volumeMounts:
            - name: downloads-mount
              mountPath: /downloads # Path inside the container
            - name: config
              mountPath: /config
            - name: vuetorrent-webui
              mountPath: /vuetorrent
          securityContext:
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
        - name: qbit-ntfy
          image: ghcr.io/vehkiya/qbit-ntfy-sidecar
          env:
            - name: QBIT_HOST
              value: "http://localhost:8080"
            - name: NTFY_SERVER
              value: "http://ntfy.monitoring.svc.cluster.local"
            - name: NTFY_TOPIC
              value: "downloads"
            - name: NTFY_PRIORITY_PROGRESS
              value: "low"
            - name: NTFY_PRIORITY_COMPLETE
              value: "default"
            - name: NOTIFY_COMPLETE
              value: "true"
            - name: PROGRESS_FORMAT
              value: "bar"
          envFrom:
            - secretRef:
                name: ntfy-credentials
          resources:
            requests:
              cpu: "10m"
              memory: "32Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"
      dnsConfig:
        options:
          - name: ndots
            value: "1"
      securityContext:
        fsGroup: 65534
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 100
        runAsNonRoot: true
        runAsUser: 1026
      volumes:
        - name: downloads-mount
          persistentVolumeClaim:
            claimName: downloads-pvc
        - name: config
          persistentVolumeClaim:
            claimName: qbittorrent-config-pvc
        - name: vuetorrent-webui
          emptyDir: { }
