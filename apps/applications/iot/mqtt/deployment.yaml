# 4-mosquitto-deployment.yaml (Complete and Corrected)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mosquitto
  namespace: iot
  labels:
    app: mosquitto
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mosquitto
  template:
    metadata:
      labels:
        app: mosquitto
    spec:
      # This container runs first to prepare the config with correct permissions
      initContainers:
        - name: prepare-config
          image: busybox:1.37@sha256:d80cd694d3e9467884fcb94b8ca1e20437d8a501096cdf367a5a1918a34fc2fd
          command: [ "/bin/sh", "-c" ]
          args:
            - |
              set -e
              echo "Copying config and password files..."
              cp /mnt/config-ro/mosquitto.conf /mosquitto-init/config/mosquitto.conf
              cp /mnt/secret-ro/password_key /mosquitto-init/config/passwordfile
              
              echo "Setting permissions and ownership..."
              # The 'mosquitto' user in the official image has UID/GID 1883
              chown -R 1883:1883 /mosquitto-init/config
              chmod 0700 /mosquitto-init/config/passwordfile
              
              echo "Preparation complete."
          volumeMounts:
            - name: config-ro
              mountPath: /mnt/config-ro
            - name: secret-ro
              mountPath: /mnt/secret-ro
            - name: config-rw
              mountPath: /mosquitto-init/config
      containers:
        - name: mosquitto
          image: eclipse-mosquitto:2.0.22@sha256:077fe4ff4c49df1e860c98335c77dda08360629e0e2a718147027e4db3eace9d
          ports:
            - containerPort: 1883
              name: mqtt
          volumeMounts:
            - name: config-rw
              mountPath: /mosquitto/config
            - name: data
              mountPath: /mosquitto/data
          readinessProbe:
            tcpSocket:
              port: 1883
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 1883
            initialDelaySeconds: 15
            periodSeconds: 20
      
      volumes:
        # Read-only volume for the original ConfigMap
        - name: config-ro
          configMap:
            name: mosquitto-config
        # Read-only volume for the original Secret
        - name: secret-ro
          secret:
            secretName: mosquitto-passwordfile
        # Writable emptyDir volume shared between init and main containers
        - name: config-rw
          emptyDir: { }
        # Persistent volume for mosquitto data
        - name: data
          persistentVolumeClaim:
            claimName: mosquitto-data-pvc