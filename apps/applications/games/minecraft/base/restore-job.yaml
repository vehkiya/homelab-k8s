apiVersion: batch/v1
kind: CronJob
metadata:
  name: restore-last-backup
  # requires manual scaling down of statefulset
spec:
  # 1. Disable automatic execution
  suspend: true
  # 2. Schedule is required but ignored due to suspend (put anything)
  schedule: "* * * * *"
  jobTemplate:
    spec:
      # Do not restart if the script crashes (prevents loops)
      backoffLimit: 0
      template:
        spec:
          securityContext:
            runAsUser: 0
          containers:
            - name: restorer
              image: alpine:latest
              env:
                - name: TARGET_STATEFULSET
                  value: "minecraft"
                - name: BACKUP_DIRECTORY # from minecraft-backup-pvc
                  value: "/backups"
                - name: RESTORE_DIRECTORY # from minecraft-data-pvc
                  value: "/data"
              command: [ "/bin/sh", "-c" ]
              args:
                - |
                  set -e
                  apk add --no-cache rsync

                  BACKUP_DIR="${BACKUP_DIRECTORY:-/backups}"
                  RESTORE_DIR="${RESTORE_DIRECTORY:-/data}"

                  echo "üìÇ Scanning $BACKUP_DIR for backups..."

                  # Find latest directory
                  LATEST_BACKUP=$(ls -d "${BACKUP_DIR}"/backup-*/ 2>/dev/null | sort -r | head -n 1)

                  if [ -z "$LATEST_BACKUP" ]; then
                    echo "‚ùå No backup directories found in $BACKUP_DIR!"
                    exit 1
                  fi

                  echo "Found latest backup: $LATEST_BACKUP"
                  echo "‚ôªÔ∏è  Restoring to: $RESTORE_DIR..."

                  # Rsync back
                  # --delete ensures files deleted in backup are removed from data (clean state)
                  rsync -av --delete "$LATEST_BACKUP/" "$RESTORE_DIR/"

                  echo "üë§ Fixing ownership to 1000:1000..."
                  chown -R 1000:1000 "$RESTORE_DIR"

                  echo "‚úÖ Restore Complete."
              volumeMounts:
                - name: data
                  mountPath: /data
                - name: backup
                  mountPath: /backups
                  subPath: backups
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: minecraft-data-pvc
            - name: backup
              persistentVolumeClaim:
                claimName: minecraft-backup-pvc
          restartPolicy: Never