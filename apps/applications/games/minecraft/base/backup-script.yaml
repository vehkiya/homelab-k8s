apiVersion: v1
kind: ConfigMap
metadata:
  name: minecraft-backup-script
  namespace: games
data:
  DEFAULT_BACKUP_SCHEDULE: "0 * * * *"
  backup.sh: |
    #!/bin/sh
    set -e

    # Ensure dependencies
    if ! command -v rsync >/dev/null; then
      echo "Installing rsync..."
      apk add --no-cache rsync
    fi

    # Check for player activity to skip idle backups
    # 1. Check if 0 players are online currently
    if rcon-cli --password "$RCON_PASSWORD" "list" | grep -q "There are 0"; then
      echo "â„¹ï¸  0 players online. Checking for recent activity..."
    
      # Ensure 'find' supports -mmin (install findutils if needed)
      if ! find --help 2>&1 | grep -q "mmin"; then
        echo "Installing findutils..."
        apk add --no-cache findutils
      fi

      # 2. Check if any playerdata file was modified in the last 60 minutes
      #    Standard path: /data/world/playerdata/
      if [ -z "$(find /data -type f -path "*/playerdata/*" -mmin -60 -print -quit)" ]; then
        echo "ğŸ’¤ No active players in the last hour. Skipping backup."
        exit 0
      fi
      echo "â„¹ï¸  Recent activity detected (files changed <1h). Proceeding..."
    fi

    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    BACKUP_NAME="backup-$TIMESTAMP"
    BACKUP_PATH="/backups/$BACKUP_NAME"

    echo "â³ Starting Backup: $BACKUP_NAME"

    # Ensure save is always turned back on
    trap 'rcon-cli --password "$RCON_PASSWORD" "save-on"' EXIT

    # RCON: Announce, Save Off & Flush
    # rcon-cli is provided by the image
    rcon-cli --password "$RCON_PASSWORD" "say Â§6[Backup] Â§fStarting server backup..."
    rcon-cli --password "$RCON_PASSWORD" "save-off"
    rcon-cli --password "$RCON_PASSWORD" "save-all"

    # Rsync Data
    DEFAULT_EXCLUDES="cache .cache logs crash-reports dynmap session.lock"
    EXCLUDE_FLAGS=""
    for item in $DEFAULT_EXCLUDES; do
      EXCLUDE_FLAGS="$EXCLUDE_FLAGS --exclude=$item"
    done

    mkdir -p "$BACKUP_PATH"
    rsync -a --no-o --no-g --delete --info=progress2 --stats $EXCLUDE_FLAGS /data/ "$BACKUP_PATH/"

    rcon-cli --password "$RCON_PASSWORD" "say Â§6[Backup] Â§fServer backup completed!"
    echo "âœ… Backup Complete: $BACKUP_PATH"

    # Prune (Keep last 10)
    cd /backups
    ls -dt backup-*/ 2>/dev/null | tail -n +11 | xargs -r rm -rf

    echo "ğŸ§¹ Pruning complete."
