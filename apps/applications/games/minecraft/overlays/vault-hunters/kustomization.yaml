apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: games

# 1. Base Logic
resources:
  - ../../base
  - external-secret.yaml

# 2. Add Name Suffix
nameSuffix: -vh

configurations:
  - kustomize-config.yaml

labels:
  - includeSelectors: true
    pairs:
      app: minecraft-vh

images:
  - name: ghcr.io/itzg/minecraft-server
    newTag: stable-java17@sha256:2818e2e7ca2ce0572c6677450e804ecc23513c9284edf10ea30fcbbe0a341024

# 3. Patches
patches:
  # === Override config ===
  - target:
      kind: ConfigMap
      name: minecraft-config
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: minecraft-config
      data:
        #  CF_PAGE_URL: "https://www.curseforge.com/minecraft/modpacks/vault-hunters-1-18-2"
        CF_SLUG: "vault-hunters-1-18-2"
        CF_FORCE_SYNCHRONIZE: "TRUE"
        TYPE: "AUTO_CURSEFORGE"
        VERSION: "1.18.2"
        OPS: "Kerrlab,JusApee"
        SERVER_NAME: "Vault Hunters S4 Server"
        DIFFICULTY: "hard"
        SPAWN_PROTECTION: "0"
        USE_AIKAR_FLAGS: "TRUE"
        USE_MEOWICE_FLAGS: "TRUE"
        # USE_MEOWICE_GRAALVM_FLAGS: "TRUE"
        INIT_MEMORY: "8G"
        MAX_MEMORY: "12G"
        VIEW_DISTANCE: "16"
        MODE: "survival"
        WHITELIST: "Kerrlab,JusApee"
        OVERRIDE_WHITELIST: "true"
        CF_FORCE_INCLUDE_MODS: "spark"
        CF_OVERRIDES_SKIP_EXISTING: "true"
  
  # === Increase default storage size ===
  - target:
      kind: PersistentVolumeClaim
      name: minecraft-data-pvc
    patch: |-
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: minecraft-data-pvc
      spec:
        resources:
          requests:
            storage: 64Gi # Increased from the base 20Gi

  # === Update backup PV for overlay ===
  - target:
      kind: PersistentVolume
      name: minecraft-backup-nfs
    patch: |-
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: minecraft-backup-nfs
        labels:
          pv-name: minecraft-backup-nfs-vh # Add suffix to label
      spec:
        nfs:
          # Using a folder for this instance of minecraft
          path: /volume1/cluster/minecraft/vault-hunters

  # === Patch base PVC so it refers the defined PV and deployment refers to renamed PVC ===
  - target:
      kind: PersistentVolumeClaim
      name: minecraft-backup-pvc
    patch: |-
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: minecraft-backup-pvc # Matches Base Name
      spec:
        selector:
          matchLabels:
            pv-name: minecraft-backup-nfs-vh

  # === Patch Deployment (Aux Mount + Unique Secret) ===
  - target:
      kind: StatefulSet
      name: minecraft
    patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: minecraft
      spec:
        template:
          spec:
            containers:
              - name: minecraft
                envFrom:
                  - configMapRef:
                      name: minecraft-config
                  - secretRef:
                      name: minecraft-vh-secret
                env:
                  - name: RCON_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: minecraft-vh-secret
                        key: RCON_PASSWORD
              - name: backup-sidecar
                env:
                  - name: RCON_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: minecraft-vh-secret
                        key: RCON_PASSWORD

  # === Patch Service to assign static IP in pool ===
  - target:
      kind: Service
      name: minecraft-vh # Matches the nameSuffix version if targeted correctly, or use base name
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: minecraft-vh
        labels:
          pool: dmz-lb-pool
        annotations:
          lbipam.cilium.io/ips: "10.20.1.140"