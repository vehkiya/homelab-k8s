apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: salt-rim-policy
  namespace: home
spec:
  endpointSelector:
    matchLabels:
      "k8s:app": salt-rim
  ingress:
    - fromEndpoints:
        - matchLabels:
            "k8s:io.kubernetes.pod.namespace": "core"
            "k8s:app.kubernetes.io/name": "traefik"
  egress:
    - toServices:
        - k8sService:
            serviceName: bar-assistant
            namespace: home
        - k8sService:
            serviceName: meilisearch-kubernetes
            namespace: default
      toPorts:
        - ports:
            - port: "8080"
              protocol: "TCP"
    - toEndpoints:
        - matchLabels:
            "k8s:io.kubernetes.pod.namespace": "kube-system"
            "k8s-app": "coredns"
      toPorts:
        - ports:
            - port: "53"
              protocol: "UDP"
            - port: "53"
              protocol: "TCP"
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: bar-assistant-policy
  namespace: home
spec:
  endpointSelector:
    matchLabels:
      "k8s:app": bar-assistant
  ingress:
    - fromEndpoints:
        - matchLabels:
            "k8s:app": salt-rim
    # Allow loopback
    - fromEndpoints:
        - matchLabels:
            "k8s:app": "bar-assistant"
  egress:
    - toEndpoints:
        - matchLabels:
            "k8s:io.kubernetes.pod.namespace": "redis"
            "k8s:app": "redis"
      toPorts:
        - ports:
            - port: "6379"
              protocol: "TCP"
    - toServices:
        - k8sService:
            serviceName: meilisearch-kubernetes
            namespace: default
      toPorts:
        - ports:
            - port: "7700"
              protocol: "TCP"
    - toEndpoints:
        - matchLabels:
            "k8s:io.kubernetes.pod.namespace": "kube-system"
            "k8s-app": "coredns"
      toPorts:
        - ports:
            - port: "53"
              protocol: "UDP"
            - port: "53"
              protocol: "TCP"
    # Allow loopback
    - toEndpoints:
        - matchLabels:
            "k8s:app": "bar-assistant"
