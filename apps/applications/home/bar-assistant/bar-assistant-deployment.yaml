# Deployment for the Bar Assistant Backend Server
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bar-assistant
  labels:
    app: bar-assistant
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: bar-assistant
  template:
    metadata:
      labels:
        app: bar-assistant
    spec:
      initContainers:
        - name: volume-permissions
          image: busybox:1.37@sha256:2383baad1860bbe9d8a7a843775048fd07d8afe292b94bd876df64a69aae7cb1
          command: [ "sh", "-c", "chown 33:33 /var/www/cocktails/storage/bar-assistant" ]
          volumeMounts:
            - name: bar-data
              mountPath: /var/www/cocktails/storage/bar-assistant
      containers:
        - name: bar-assistant-server
          image: ghcr.io/karlomikus/barassistant:5.11.2@sha256:0f2b1a8cd148e4a5ec24e8fa601b48a9d63f935942ca0b1ab8e4d5d348dfbb5d
          envFrom:
            - configMapRef:
                name: bar-assistant-config
          # Map MEILI_MASTER_KEY from Secret explicitly to MEILISEARCH_KEY env var
          env:
            - name: MEILISEARCH_KEY
              valueFrom:
                secretKeyRef:
                  name: meilisearch-kubernetes-master-key
                  key: MEILI_MASTER_KEY
            - name: AUTHELIA_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: bar-assistant-secrets
                  key: OIDC_CLIENT_SECRET
#            - name: REDIS_PASSWORD
#              valueFrom:
#                secretKeyRef:
#                  name: redis-secret
#                  key: redis-password
          volumeMounts:
            - name: bar-data
              mountPath: /var/www/cocktails/storage/bar-assistant
      volumes:
        - name: bar-data
          persistentVolumeClaim:
            claimName: bar-assistant-config-pvc