# Deployment for the Bar Assistant Backend Server
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bar-assistant
  labels:
    app: bar-assistant
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: bar-assistant
  template:
    metadata:
      labels:
        app: bar-assistant
    spec:
      initContainers:
        - name: volume-permissions
          image: busybox:1.37@sha256:d80cd694d3e9467884fcb94b8ca1e20437d8a501096cdf367a5a1918a34fc2fd
          command: [ "sh", "-c", "chown 33:33 /var/www/cocktails/storage/bar-assistant" ]
          volumeMounts:
            - name: bar-data
              mountPath: /var/www/cocktails/storage/bar-assistant
      containers:
        - name: bar-assistant-server
          image: ghcr.io/karlomikus/barassistant:5.11.1@sha256:2b9499e1e66ca68344afa892fb15b39ae2cc8f7158556427f0513098dc3d6e2c
          envFrom:
            - configMapRef:
                name: bar-assistant-config
          # Map MEILI_MASTER_KEY from Secret explicitly to MEILISEARCH_KEY env var
          env:
            - name: MEILISEARCH_KEY
              valueFrom:
                secretKeyRef:
                  name: meilisearch-kubernetes-master-key
                  key: MEILI_MASTER_KEY
            - name: AUTHELIA_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: bar-assistant-secrets
                  key: OIDC_CLIENT_SECRET
#            - name: REDIS_PASSWORD
#              valueFrom:
#                secretKeyRef:
#                  name: redis-secret
#                  key: redis-password
          volumeMounts:
            - name: bar-data
              mountPath: /var/www/cocktails/storage/bar-assistant
      volumes:
        - name: bar-data
          persistentVolumeClaim:
            claimName: bar-assistant-config-pvc