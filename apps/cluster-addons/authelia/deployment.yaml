# authelia/deployment.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: authelia
  namespace: core
  labels:
    app: authelia
spec:
  selector:
    matchLabels:
      app: authelia
  template:
    metadata:
      labels:
        app: authelia
    spec:
      enableServiceLinks: false
      initContainers:
        - name: prepare-config
          image: alpine/k8s
          command:
            - /bin/sh
            - -c
            - |
              echo "üöÄ Starting Configuration Processing..."
              echo "--------------------------------------------------"
              DEBUG="false"

              CONFIG_TEMPLATE_PATH="/config_templates/configuration-template.yml"
              FINAL_CONFIG_PATH="/config/configuration.yml"

              echo "‚ÑπÔ∏è Template Path: $CONFIG_TEMPLATE_PATH"
              echo "‚ÑπÔ∏è Output Path: $FINAL_CONFIG_PATH"
              echo "--------------------------------------------------"

              # Check if template file exists
              if [ ! -f "$CONFIG_TEMPLATE_PATH" ]; then
                echo "‚ùå ERROR: Config template '$CONFIG_TEMPLATE_PATH' not found! Aborting."
                exit 1
              fi

              if [ "$DEBUG" = "true" ]; then
                echo "üìÑ Contents of template '$CONFIG_TEMPLATE_PATH':"
                cat "$CONFIG_TEMPLATE_PATH"
                echo "--------------------------------------------------"
              fi

              echo "‚öôÔ∏è  Generating final configuration file from template..."
              if envsubst < "$CONFIG_TEMPLATE_PATH" > "$FINAL_CONFIG_PATH"; then
                echo "‚úÖ Configuration file '$FINAL_CONFIG_PATH' generated successfully."
              else
                echo "‚ùå ERROR: Failed to generate configuration file '$FINAL_CONFIG_PATH' using envsubst."
                ls -la /config
                exit 1 # Critical step failed
              fi
              echo "--------------------------------------------------"

              if [ "$DEBUG" = "true" ]; then
                echo "üìÑ Verifying generated configuration file '$FINAL_CONFIG_PATH':"
                cat "$FINAL_CONFIG_PATH" # For verification in logs
                echo "--------------------------------------------------"

                echo "üîé Contents of /config directory after processing:"
                ls -la /config
                echo "--------------------------------------------------"
              fi

              echo "üéâ Configuration processing complete."
          envFrom: # This injects all keys from the secret as environment variables
            - secretRef:
                name: authelia-secrets
            - secretRef:
                name: authelia-oidc-secrets
          volumeMounts:
            - name: config-template-volume
              mountPath: /config_templates
            - name: config-volume
              mountPath: /config
          securityContext:
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
      containers:
        - name: authelia
          image: ghcr.io/authelia/authelia
          ports:
            - name: http
              containerPort: 9091
              hostPort: 9091
              protocol: TCP
          env:
            - name: X_AUTHELIA_CONFIG_FILTERS
              value: "template"
          # Load all keys from the 'authelia-secrets' Secret as environment variables
          envFrom:
            - secretRef:
                name: authelia-secrets
          volumeMounts:
            - name: config-volume
              mountPath: /config
            - name: authelia-keys
              mountPath: /config/secrets
      
      volumes:
        - name: authelia-keys
          secret:
            secretName: authelia-secrets-files
            items:
              - key: oidc_private.pem
                path: oidc/jwks/oidc_private.pem
        - name: config-template-volume
          configMap:
            name: authelia-config
        - name: config-volume
          emptyDir: { }