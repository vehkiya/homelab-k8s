apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: coredns
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://coredns.github.io/helm'
    chart: coredns
    targetRevision: '1.43.3' # Pin to a specific chart version for stability
    helm:
      # You can either reference a values file in another git repo,
      # or paste the values directly here for a self-contained application.
      values: |
        # https://github.com/coredns/helm
        
        replicaCount: 3
        
        service:
          name: kube-dns
          clusterIP: "10.96.0.10" # Default kube-dns service IP in the 10.96.0.0/12 range
        
        # Ensure pods are spread across different nodes for high availability.
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchExpressions:
                      - key: "app.kubernetes.io/name"
                        operator: In
                        values:
                          - coredns
                  topologyKey: "kubernetes.io/hostname"
        
        # Enable Prometheus monitoring. The chart will create a ServiceMonitor resource.
        prometheus:
          service:
            enabled: true
        serviceMonitor:
          enabled: true
        
        # --------------------------------------------------------------------------
        #               *** Custom CoreDNS Configuration Section ***
        # This section defines the entire behavior of CoreDNS using the robust
        # 'file' plugin approach we decided on previously.
        # --------------------------------------------------------------------------
        
        # Use a completely custom Corefile, defined below.
        customCorefile:
          enabled: true
          config: |
            .:53 {
                # Standard Plugins
                errors
                health {
                    lameduck 5s
                }
                ready
                prometheus :9153
                log . {
                    class error
                }
        
                # --- Custom DNS Zone for kerrlab.app ---
                # Authoritatively serves the kerrlab.app zone from a file.
                # This handles both specific records and the wildcard correctly.
                file /etc/coredns/db.kerrlab.app kerrlab.app
        
                # --- Core Kubernetes DNS ---
                kubernetes cluster.local in-addr.arpa ip6.arpa {
                    pods insecure
                    fallthrough in-addr.arpa ip6.arpa
                    ttl 30
                }
        
                # --- Performance & Forwarding ---
                # Cache is placed before forward for maximum effectiveness.
                cache 600
                # Forward to your gateway (10.10.1.1) first, with a public fallback.
                forward . 10.10.1.1 1.1.1.1 {
                    policy sequential
                    max_concurrent: 1000
                }
        
                # --- Standard Utilities ---
                loop
                reload
                loadbalance
            }
        
        # This will create the db.kerrlab.app zone file in the same ConfigMap
        # and mount it to /etc/coredns/ so the 'file' plugin can read it.
        customZoneFiles:
          enabled: true
          files:
            - filename: "db.kerrlab.app"
              contents: |
                $TTL 60
                @   IN  SOA ns.kerrlab.app. hostmaster.kerrlab.app. (
                        2025090101  ; Serial (YYYYMMDDNN format)
                        7200        ; Refresh
                        3600        ; Retry
                        1209600     ; Expire
                        60 )        ; Negative Cache TTL
                ;
                ; Name Servers
                @           IN  NS  ns.kerrlab.app.
                ns          IN  A   127.0.0.1
                ;
                ; A Records for NAS-hosted services
                fortress    IN  A   10.10.1.218
                nas         IN  A   10.10.1.218
                ldap        IN  A   10.10.1.218
                vaultwarden IN  A   10.10.1.218
                ;
                ; A Record for the Reverse Proxy
                proxy       IN  A   10.10.1.221
                ;
                ; Wildcard for all other services in the cluster
                * IN  A   10.10.1.221
  destination:
    server: https://kube.kerrlab.app:6443
    namespace: kube-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true