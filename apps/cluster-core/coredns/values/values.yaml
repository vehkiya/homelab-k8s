# https://github.com/coredns/helm

replicaCount: 3

service:
  name: coredns
  clusterIP: "10.96.0.10" # Default coredns service IP in the 10.96.0.0/12 range
  # K8s 1.35 feature
  trafficDistribution: PreferSameNode
  ipFamilyPolicy: SingleStack
  ipFamilies:
    - IPv4
#    - IPv6

# Ensure pods are spread across different nodes for high availability.
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: "app.kubernetes.io/name"
                operator: In
                values:
                  - coredns
          topologyKey: "kubernetes.io/hostname"

# Enable Prometheus monitoring. The chart will create a ServiceMonitor resource.
prometheus:
  service:
    enabled: true
serviceMonitor:
  enabled: true

servers:
  - zones:
      - zone: .
        use_tcp: true
    port: 53
    # -- expose the service on a different port
    # servicePort: 5353
    # If serviceType is nodePort you can specify nodePort here
    # nodePort: 30053
    # hostPort: 53
    plugins:
      - name: errors
      # Serves a /health endpoint on :8080, required for livenessProbe
      - name: health
        configBlock: |-
          lameduck 5s
      # Serves a /ready endpoint on :8181, required for readinessProbe
      - name: ready
      # Required to query kubernetes API for data
      - name: file
        parameters: /etc/coredns/db.kerrlab.app kerrlab.app
      - name: kubernetes
        parameters: cluster.local in-addr.arpa ip6.arpa
        configBlock: |-
          pods insecure
          fallthrough in-addr.arpa ip6.arpa
          ttl 30
      # === IPv6 disabled, fail fast ===
      - name: template
        parameters: ANY AAAA
        config:
          rcode: NXDOMAIN
      - name: forward
        parameters: . /etc/resolv.conf
        configBlock: |-
          policy random
          max_concurrent 1000
      - name: cache
        parameters: 600
      - name: prometheus
        parameters: 0.0.0.0:9153
      - name: loop
      - name: reload
      - name: loadbalance

# --------------------------------------------------------------------------
# This will create the db.kerrlab.app zone file in the same ConfigMap
# and mount it to /etc/coredns/ so the 'file' plugin can read it.
zoneFiles:
  - filename: "db.kerrlab.app"
    contents: |
      $TTL 60
      @   IN  SOA ns.kerrlab.app. hostmaster.kerrlab.app. (
              2025090101  ; Serial (YYYYMMDDNN format)
              7200        ; Refresh
              3600        ; Retry
              1209600     ; Expire
              60 )        ; Negative Cache TTL
      ;
      ; Name Servers
      @           IN  NS  ns.kerrlab.app.
      ns          IN  A   127.0.0.1
      ;
      ; A Records for NAS-hosted services
      fortress    IN  A   10.10.1.218
      ; CNAMEs for NAS-hosted services
      nas         IN  CNAME fortress.kerrlab.app.
      ldap        IN  CNAME fortress.kerrlab.app.
      vaultwarden IN  CNAME fortress.kerrlab.app.
      ;
      ; A Records for endpoint services
      kube    IN  A   10.10.1.250
      ; A Record for the Reverse Proxy
      proxy       IN  A   10.10.1.16
      ; A Records for other services in domain
      mc       IN  A   185.206.149.82
      ;
      ; Wildcard for all other services in the cluster
      * IN  A   10.10.1.16