apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/refs/tags/v4.2.2/deployments/multus-daemonset-thick.yml

patches:
  - patch: |-
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: kube-multus-ds # This name is used for matching, but not patched
      spec:
        template:
          spec:
            volumes:
              - name: host-run-netns
                hostPath:
                  path: /var/run/netns
    target:
      kind: DaemonSet
      name: kube-multus-ds
      namespace: kube-system
  - patch: |-
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: kube-multus-ds
      spec:
        template:
          spec:
            initContainers:
              - command:
                  - /install-cni.sh
                image: ghcr.io/siderolabs/install-cni:v1.9.0@sha256:53bdeb6c8d238dd593ee75f265baf4625925a034d8d18f10ffeae88d7fcf2c3e  # adapt to your talos version
                name: install-cni
                securityContext:
                  privileged: true
                volumeMounts:
                  - mountPath: /host/opt/cni/bin
                    mountPropagation: Bidirectional
                    name: cnibin
              - name: install-multus-binary
                command:
                  - "/usr/src/multus-cni/bin/install_multus"
                  - "-d"
                  - "/host/opt/cni/bin"
                  - "-t"
                  - "thick"
    target:
      kind: DaemonSet
      name: kube-multus-ds
      namespace: kube-system
  - patch: |-
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: kube-multus-ds
      spec:
        template:
          spec:
            containers:
              - name: kube-multus
                resources:
                  limits:
                    memory: 2560Mi
    target:
      kind: DaemonSet
      name: kube-multus-ds
      namespace: kube-system 