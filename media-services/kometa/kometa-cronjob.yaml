apiVersion: batch/v1
kind: CronJob
metadata:
    name: kometa
    namespace: media
spec:
    schedule: "@daily"
    jobTemplate:
        spec:
            template:
                spec:
                    securityContext:
                        runAsUser: 1000
                        runAsGroup: 1000
                        fsGroup: 1000
                    initContainers:
                        - name: prepare-config
                          image: alpine/k8s:1.33.0
                          command:
                              - /bin/sh
                              - -c
                              - |
                                echo "Starting configuration processing..."
                                CONFIG_TEMPLATE_PATH="/config_templates/config.yml"
                                FINAL_CONFIG_PATH="/config/config.yml"

                                echo "Template path: $CONFIG_TEMPLATE_PATH"
                                echo "Output path: $FINAL_CONFIG_PATH"
                                echo "/config"
                                ls -las /config
                                echo "/config_templates"
                                ls -las /config_templates
                                echo "template contents"
                                cat $CONFIG_TEMPLATE_PATH
                                if [ ! -f "$CONFIG_TEMPLATE_PATH" ]; then
                                  echo "ERROR: Config template $CONFIG_TEMPLATE_PATH not found!"
                                  exit 1
                                fi

                                envsubst < "$CONFIG_TEMPLATE_PATH" > "$FINAL_CONFIG_PATH"

                                echo "Configuration file generated at $FINAL_CONFIG_PATH:"
                                cat "$FINAL_CONFIG_PATH" # For verification in logs

                                echo "Contents of /config after processing:"
                                ls -la /config

                                echo "Configuration processing complete."
                          envFrom: # This injects all keys from the secret as environment variables
                              - secretRef:
                                    name: kometa-secrets
                          volumeMounts:
                              - name: config
                                mountPath: /config
                              - name: kometa-config
                                mountPath: /config_templates/config.yml
                                subPath: config.yml
                    containers:
                        - name: kometa
                          image: kometateam/kometa:v2.2.0
                          imagePullPolicy: IfNotPresent
                          args: [ "--run", "--read-only-config" ]
                          resources:
                              limits:
                                  cpu: 500m
                                  memory: 512Mi
                              requests:
                                  cpu: 500m
                                  memory: 512Mi
                          volumeMounts:
                              - name: config
                                mountPath: /config
#                              - name: kometa-config
#                                mountPath: /config/config.yml
#                                subPath: config.yml
                              - name: movie-config
                                mountPath: /config/movies.yaml
                                subPath: movies.yaml
                              - name: tv-config
                                mountPath: /config/tv.yaml
                                subPath: tv.yaml
                              - name: anime-config
                                mountPath: /config/anime.yaml
                                subPath: anime.yaml
                    volumes:
                        - name: config
                          persistentVolumeClaim:
                              claimName: kometa-config-pvc
                        - configMap:
                              name: kometa-config
                          name: kometa-config
                        - configMap:
                              name: kometa-movie-config
                          name: movie-config
                        - configMap:
                              name: kometa-tv-config
                          name: tv-config
                        - configMap:
                              name: kometa-anime-config
                          name: anime-config
                    restartPolicy: OnFailure