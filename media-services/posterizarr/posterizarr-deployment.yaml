apiVersion: apps/v1
kind: Deployment
metadata:
  name: posterizarr
  namespace: media
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: posterizarr
  template:
    metadata:
      labels:
        app: posterizarr
    spec:
      securityContext:
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
        supplementalGroups:
          - 6
      terminationGracePeriodSeconds: 30
      initContainers:
        - name: prepare-config
          image: alpine/k8s:1.33.1
          command:
            - /bin/sh
            - -c
            - |
              echo "üöÄ Starting Configuration Processing..."
              echo "--------------------------------------------------"
              DEBUG="false"

              CONFIG_TEMPLATE_PATH="/config_templates/config.json.template"
              FINAL_CONFIG_PATH="/config/config.json"

              echo "‚ÑπÔ∏è Template Path: $CONFIG_TEMPLATE_PATH"
              echo "‚ÑπÔ∏è Output Path: $FINAL_CONFIG_PATH"
              echo "--------------------------------------------------"

              # Check if template file exists
              if [ ! -f "$CONFIG_TEMPLATE_PATH" ]; then
                echo "‚ùå ERROR: Config template '$CONFIG_TEMPLATE_PATH' not found! Aborting."
                exit 1
              fi

              if [ "$DEBUG" = "true" ]; then
                echo "üìÑ Contents of template '$CONFIG_TEMPLATE_PATH':"
                cat "$CONFIG_TEMPLATE_PATH"
                echo "--------------------------------------------------"
              fi

              echo "‚öôÔ∏è  Generating final configuration file from template..."
              if envsubst < "$CONFIG_TEMPLATE_PATH" > "$FINAL_CONFIG_PATH"; then
                echo "‚úÖ Configuration file '$FINAL_CONFIG_PATH' generated successfully."
              else
                echo "‚ùå ERROR: Failed to generate configuration file '$FINAL_CONFIG_PATH' using envsubst."
                ls -la /config
                exit 1 # Critical step failed
              fi
              echo "--------------------------------------------------"

              if [ "$DEBUG" = "true" ]; then
                echo "üìÑ Verifying generated configuration file '$FINAL_CONFIG_PATH':"
                cat "$FINAL_CONFIG_PATH" # For verification in logs
                echo "--------------------------------------------------"

                echo "üîé Contents of /config directory after processing:"
                ls -la /config
                echo "--------------------------------------------------"
              fi

              echo "üéâ Configuration processing complete."
          envFrom: # This injects all keys from the secret as environment variables
            - secretRef:
                name: posterizarr-secret
          volumeMounts:
            - name: config
              mountPath: /config
            - name: app-config-tpl-volume # Mount the ConfigMap template
              mountPath: /config_templates
      containers:
        - name: posterizarr
          image: ghcr.io/fscorrupt/posterizarr:1.9.64
          env:
            - name: TZ
              value: "Europe/Chisinau"
            - name: RUN_TIME
              value: "23:30"
          volumeMounts:
            - name: assets
              mountPath: /assets
            - name: config
              mountPath: /config
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: posterizarr-config-pvc
        - name: assets
          persistentVolumeClaim:
            claimName: posterizarr-data-pvc
        - name: app-config-tpl-volume
          configMap:
            name: posterizarr-configmap
            items:
              - key: config.json.template
                path: config.json.template