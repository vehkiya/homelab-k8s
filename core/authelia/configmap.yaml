# authelia/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-config
  namespace: core
data:
  configuration-template.yml: |
    # Authelia Configuration
    server:
      address: 'tcp://0.0.0.0:9091'

    session:
      name: authelia_session
      # This should match the root domain you are protecting
      # The secret is loaded from an environment variable
      secret: "${SESSION_SECRET}"
      same_site: 'lax'
      inactivity: '15m'
      expiration: '2h'
      remember_me: '1M'
      cookies:
        - domain: 'kerrlab.app'
          authelia_url: 'https://auth.kerrlab.app'
          default_redirection_url: 'https://kerrlab.app'
          name: 'authelia_session'
          same_site: 'lax'
          inactivity: '5m'
          expiration: '1h'
          remember_me: '1d'
  
      redis:
        host: 'redis-master.redis.svc.cluster.local'
        port: 6379
        timeout: '5s'
        max_retries: 0
        password: '${REDIS_PASSWORD}'
        database_index: 1
        maximum_active_connections: 8
        minimum_idle_connections: 0
      
    # JSON Web Token (JWT) 
    identity_validation:

      ## Reset Password flow. Adjusts how the reset password flow operates.
      reset_password:
        ## Maximum allowed time before the JWT is generated and when the user uses it in the duration common syntax.
        # jwt_lifespan: '5 minutes'
    
        ## The algorithm used for the Reset Password JWT.
        # jwt_algorithm: 'HS256'
    
        ## The secret key used to sign and verify the JWT.
        jwt_secret: "${JWT_SECRET}"

    # Regulation settings
    regulation:
      max_retries: 3
      find_time: 120
      ban_time: 300

    # Storage configuration using PostgreSQL
    storage:
      encryption_key: "${STORAGE_ENCRYPTION_KEY}"
      postgres:
        address: 'tcp://postgres-db-rw.postgres.svc:5432'
        database: authelia-db
        username: authelia_user
        # The password is loaded from an environment variable
        password: "${STORAGE_PASSWORD}"

    # Notifier configuration (SMTP example)
    notifier:
      smtp:
        address: 'smtp://smtp.protonmail.ch:587'
        sender: "Authelia <accounts@kerrlab.app>"
        username: "${SMTP_USERNAME}"
        password: "${SMTP_PASSWORD}"
        subject: "[Authelia] {title}"
        tls:
          server_name: "smtp.protonmail.ch"
          skip_verify: false

    # Authentication backend using LDAP
    authentication_backend:
      ldap:
        address: 'ldaps://ldap.kerrlab.app:636'
        start_tls: false
        base_dn: "${LDAP_BASE_DN}"
        # Credentials for the user that will perform searches
        user: "${LDAP_BIND_DN}"
        # The password is loaded from an environment variable
        password: "${LDAP_PASSWORD}"
        # Search filter for users
        users_filter: '(&({username_attribute}={input})(objectClass=person))'
        # Search filter for groups
        groups_filter: '(&(objectClass=posixGroup)(memberUid={username}))'
        # Attributes for user profiles
        attributes:
          distinguished_name: 'distinguishedName'
          username: 'uid'
          display_name: 'displayName'
          family_name: 'sn'
          given_name: 'givenName'
          middle_name: 'middleName'
          nickname: ''
          gender: ''
          birthdate: ''
          website: 'wWWHomePage'
          profile: ''
          picture: ''
          zoneinfo: ''
          locale: ''
          phone_number: 'telephoneNumber'
          phone_extension: ''
          street_address: 'streetAddress'
          locality: 'l'
          region: 'st'
          postal_code: 'postalCode'
          country: 'c'
          mail: 'mail'
          member_of: 'memberOf'
          group_name: 'cn'
          extra:
            extra_example:
              name: ''
              multi_valued: false
              value_type: 'string'

    # Access control rules
    access_control:
      default_policy: deny
      rules:
        # Allow authenticated users to access all subdomains of kerrlab.app
        - domain: "*.kerrlab.app"
          policy: two_factor
    
    totp:
      disable: false
      issuer: 'authelia.com'
      algorithm: 'sha1'
      digits: 6
      period: 30
      skew: 1
      secret_size: 32
      allowed_algorithms:
        - 'SHA1'
      allowed_digits:
        - 6
      allowed_periods:
        - 30
      disable_reuse_security_policy: false    

    webauthn:
      disable: false
      enable_passkey_login: true
      display_name: 'Kerrlab'
      attestation_conveyance_preference: 'indirect'
      timeout: '60 seconds'
      filtering:
        permitted_aaguids: [ ]
        prohibited_aaguids: [ ]
        prohibit_backup_eligibility: false
      selection_criteria:
        attachment: ''
        discoverability: 'preferred'
        user_verification: 'preferred'
      metadata:
        enabled: false
        validate_trust_anchor: true
        validate_entry: true
        validate_entry_permit_zero_aaguid: false
        validate_status: true
        validate_status_permitted: [ ]
        validate_status_prohibited:
          - 'REVOKED'
          - 'USER_KEY_PHYSICAL_COMPROMISE'
          - 'USER_KEY_REMOTE_COMPROMISE'
          - 'USER_VERIFICATION_BYPASS'
          - 'ATTESTATION_KEY_COMPROMISE'
          
    identity_providers:
      oidc:
        hmac_secret: "${OIDC_HMAC_SECRET}"
        jwks:
          - key_id: 'oidc_pk'
            key: {{ secret "/config/secrets/oidc/jwks/oidc_private.pem" | mindent 10 "|" | msquote }}
        clients:
          - client_id: 'mealie'
            client_name: 'Mealie'
            client_secret: '${MEALIE_SECRET}'
            public: false
            authorization_policy: 'two_factor'
            require_pkce: true
            pkce_challenge_method: 'S256'
            consent_mode: 'pre-configured'
            pre_configured_consent_duration: '1 week'
            redirect_uris:
              - 'https://recipes.kerrlab.app/login'
              - 'https://recipes.kerrlab.app/login?direct=1'
            scopes:
              - 'openid'
              - 'email'
              - 'profile'
              - 'groups'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'
            access_token_signed_response_alg: 'none'
            userinfo_signed_response_alg: 'none'
            token_endpoint_auth_method: 'client_secret_basic'
          - client_id: 'oauth2-proxy'
            client_name: 'OAuth2 Proxy'
            client_secret: '${OAUTH_PROXY_SECRET}'
            public: false
            authorization_policy: 'one_factor'
            consent_mode: 'pre-configured'
            pre_configured_consent_duration: '1 week'
            pre_configured_consent_duration: '1 week'
            redirect_uris:
              - 'https://oauth.kerrlab.app/oauth2/callback'
            scopes:
              - 'openid'
              - 'profile'
              - 'email'
              - 'groups'
            response_types:
              - 'code'
            grant_types:
              - 'authorization_code'